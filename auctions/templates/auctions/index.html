{% extends "auctions/layout.html" %}
{% load static %}
{% block body %}
<div class="container">
    <h2 class="mt-4">Active Listings</h2>

    <ul class="list-group">
        {% for listing in listing_list %}
            <li class="list-group-item" data-id="{{ listing.id }}">
                <a href="{% url 'listings' id=listing.id %}?next={{ request.path }}">
                    <strong>{{ listing.title }}</strong><br>
                    Description: {{ listing.description }}
                    {% if listing.imageurl %}
                        <img src="{{ listing.imageurl }}" alt="{{ listing.title }}">
                    {% endif %}
                </a>
                <br>
    
                {% if not listing.active %}
                    <p class="closed-listing">This listing is closed.</p>
                {% elif listing.winner %}
                    <p class="winner-listing">This listing has a winner: {{ listing.winner }}</p>
                {% else %}
                    <p><b>Starting Bid:</b> ${{ listing.startingbid }}</p>
    
                    {% if listing.latest_bid %}
                        <p><b>Current Bid:</b> ${{ listing.latest_bid.amount }}</p>
                    {% else %}
                        <p><b>Current Price:</b> ${{ listing.currentprice }}</p>
                    {% endif %}
    
                    <p><b>Category:</b> {{ listing.category }}</p>
    
                    {% if request.user.is_authenticated %}
                        <a href="{% url 'add_watch' id=listing.id %}" class="btn add-to-watchlist">Add to Watchlist</a>
                        <a href="{% url 'unwatch' id=listing.id %}" class="btn remove-from-watchlist">Remove from Watchlist</a>
                    {% endif %}
                {% endif %}
            </li>
        {% endfor %}
    </ul>    
  
    <div id="notificationArea" style="position: fixed; top: 10px; right: 30px; background-color: rgb(21, 115, 191);"></div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const addButtons = document.querySelectorAll('.add-to-watchlist');
        const removeButtons = document.querySelectorAll('.remove-from-watchlist');
        const notificationArea = document.getElementById('notificationArea');

        // Function to display notifications
        function showNotification(message) {
            notificationArea.innerText = message;
            notificationArea.style.display = 'block';
            setTimeout(() => {
                notificationArea.style.display = 'none';
            }, 6000);
        }

        // Helper function to check if item is in the watchlist
        function isInWatchlist(itemId) {
            return localStorage.getItem('watchlist') && JSON.parse(localStorage.getItem('watchlist')).includes(itemId);
        }

        addButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const itemId = this.closest('li').dataset.id;

                this.style.display = 'none';

                fetch(this.href, { method: 'GET' })  
                    .then(response => {
                        if (response.ok) {
                            let watchlist = localStorage.getItem('watchlist') ? JSON.parse(localStorage.getItem('watchlist')) : [];
                            watchlist.push(itemId);
                            localStorage.setItem('watchlist', JSON.stringify(watchlist));

                            // Show notification
                            showNotification('Item Added to watchlist!');

                            // Enable the remove button, if it exists
                            if (this.nextElementSibling) {
                                this.nextElementSibling.style.display = 'inline-block';
                            }
                        }
                    })
                    .catch(() => {
                        // In case of an error, make the button visible again
                        this.style.display = 'inline-block';
                        showNotification('Failed to add to watchlist.');
                    });
            });
        });

        // Add click event listeners to remove-from-watchlist buttons
        removeButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const itemId = this.closest('li').dataset.id;

                // Hide the button immediately
                this.style.display = 'none';

                fetch(this.href, { method: 'GET' })
                    .then(response => {
                        if (response.ok) {
                            let watchlist = JSON.parse(localStorage.getItem('watchlist')) || [];
                            watchlist = watchlist.filter(id => id !== itemId);
                            localStorage.setItem('watchlist', JSON.stringify(watchlist));

                            // Show notification
                            showNotification('Removed from watchlist!');

                            // Enable the add button, if it exists
                            if (this.previousElementSibling) {
                                this.previousElementSibling.style.display = 'inline-block';
                            }
                        }
                    })
                    .catch(() => {
                        // In case of an error, make the button visible again
                        this.style.display = 'inline-block';
                        showNotification('Failed to remove from watchlist.');
                    });
            });
        });

        // On page load, check the status of each item and render the buttons appropriately
        document.querySelectorAll('.list-group-item').forEach(item => {
            const itemId = item.dataset.id;
            const addButton = item.querySelector('.add-to-watchlist');
            const removeButton = item.querySelector('.remove-from-watchlist');

            // Check if the buttons exist before trying to modify their display state
            if (addButton && removeButton) {
                if (isInWatchlist(itemId)) {
                    addButton.style.display = 'none';
                    removeButton.style.display = 'inline-block';
                } else {
                    addButton.style.display = 'inline-block';
                    removeButton.style.display = 'none';
                }
            }
        });
    });
</script>
</div>
{% endblock %}
